# 第三章 FFmpeg 入门

本章开始正式入门FFmpeg，我将对FFmpeg环境配置、主要编码及基本数据类型做出详细的介绍。

## 配置环境

在Win32环境配置FFmpeg开发有一个非常简单的方法：

1. 安装Visual Studio 2017，并安装英文语言包
2. 安装vcpkg，并执行vcpkg install ffmpeg*:x86-windows ffmpeg*:x86-windows-static
3. 此时新建一个项目即可直接使用FFmpeg

其他方式配置稍显麻烦，此处暂时不列出

另外还需要安装一个FFmpeg命令行环境，推荐官网直接下一个，需要注意的是下载的是GPL协议的开发库。

## 容器及编码

### 容器

容器通常是一种文件格式或流媒体格式，用来描述纯视频、纯音频或音视频的存储格式。

纯音频容器格式有mp3、aac、wma等，通常你放的歌均使用这种容器来存储。

纯视频容器格式我暂时没见过，可能有。

混合容器格式有mp4、flv、vob、rmvb等，通常看的视频，音视频都有的格式就使用这种存储格式，它们除了能混合存储，还能仅存放音频或视频。比如一首mp3的歌转为flv格式来播放完全是没问题的。

### 图像编码

未压缩编码格式有rgb/bgr、hsl/hsv/hsb、yuv等等系列，因体积因素，使用最广泛的是yuv系列。这类编码方式有一个共同的特点，也就是抽取其中任意一帧都能表述整个图像。

压缩编码格式有h263/h264/h265、vp8/vp9/av1、flv1等等，这类图像均经过压缩，只有I帧能完整还原整个画面（前提是知道metadata信息），其他类型的帧可能是在I帧基础上做一些改动的描述，比如有了I帧后，新的帧可以对其做出一定的修改；也可能压根不存储画面信息，只存放metadata或SEI信息（h264/h265）等。

### 音频编码

未压缩的音频编码有两个主要概念，一个是格式，一个是采样率。通常格式是使用16位有符号数字作为采样，取值范围-32768~32767，网上看到的很多音频处理软件的声音波形图就是这个值；除了这个外，还能用8位整数、32位整数、32位float来表示，存储容量越大，声音也就越保真。通常16位能满足绝大多数人对声音需求，所以很少有场景使用32位无损音质。同时32位也是人类对声音分辨的极限，超过32位的比如64位音质，一方面没任何优势，另一方面浪费存储空间。

采样率的意思是每秒钟存储多少个声音的值，主流使用44.1KHz，也就是每秒钟有44100个采样点，能满足绝大多数人的需求了。同时人类对采样率识别的极限是48KHz，也就是每秒钟有48000个采样点。超过这个频率的音质对人类来说没有任何区别，除非特殊场合，否则48KHz完全足够，主流依然是44.1KHz。

## format、stream

FFmpeg中使用AVFormatContext来描述一个容器，这个结构体可用于读写流数据，比如读写flv、rmvb、mp3等文件或推流、拉流均使用这个结构体。

结构体中nb_streams成员代表流的数量。比如一个mp3文件通常只有一个音频流；一个摄像头视频源通常只有一个视频流；一个flv容器通常有2-3个流，分别为视频流、音频流或视频流、音频流、字母流。通过结构体中streams成员进行访问。

## codec、pixel format

FFmpeg中使用一个AVCodecID枚举成员来表示一种音频或视频编码，也就是无法直接处理的编码（基本为已压缩编码），比如h264、vp9等。

FFmpeg中使用一个AVPixelFormat枚举成员来表示一种像素格式，也就是可以直接处理的图像编码（均为未压缩编码），比如RGB24、YUV420P等。

FFmpeg中使用一个AVSampleFormat枚举成员来表示一种音频采样格式，也就是可以直接处理的音频编码（均为未处理编码），比如s16（有符号16位整数）等。

## packet、frame

FFmpeg中使用AVPacket来代表一个数据包，通常从音视频文件中读出来的、摄像头麦克风读出来的、或即将写入文件的音视频数据，均使用这种结构体来描述数据。基本上为已压缩的编码。很多人可能有疑问，雷神的博客很多直接从文件中读AVFrame，或者直接将AVFrame写文件的骚操作又是啥？其实这种情况下读写的文件都是自定义的格式，而不是标准格式了。这样写出的文件，100%的常用音视频软件都无法直接解析。只有在测试的时候用用，学会这一块之后都不要这么操作了。

FFmpeg中使用AVFrame来代表一个音视频帧，一帧图像是一个未压缩的完整画面，可用于直接处理，比如瘦脸、去绿幕背景等，均由操作AVFrame实现；另外还可能是一帧音频，里面包括的采样数不一定，可能是320、480，也可能是1024、10000等等。

[返回首页](../README.md) | [上一章 音频基础](./02_audio_introduce.md) | [下一章 Hello FFmpeg](./04_hello_ffmpeg.md)

## 许可

[![test](https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png)](http://creativecommons.org/licenses/by-nc-nd/4.0/)

本教程采用[知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议](http://creativecommons.org/licenses/by-nc-nd/4.0/)许可。
